!function(a){"use strict";angular.module("secureNgResource",["ngResource","ngCookies"]),angular.module("secureNgResource").factory("authSession",["$q","$location","$cookieStore","$injector","$rootScope","$timeout",function(a,b,c,d,e,f){var g={sessionName:"angular",loginPath:"/login",logoutUrl:null,defaultPostLoginPath:"/",useCookies:!0},h={},i=function(a,b){if(this.auth=a,this.settings=angular.extend({},g,b),this.priorPath=null,this.state=null,this.managedHttpConfs=[],this.refreshPromise=null,h[this.cookieKey()]=this,this.settings.useCookies){var d=c.get(this.cookieKey());d?this.state=d:this.reset()}else this.reset()};i.prototype={getUserName:function(){return this.loggedIn()?this.state.user:void 0},loggedIn:function(){return null!==this.state},login:function(a){var c=this;return this.auth.checkLogin(a).then(function(d){c.state=d.newState,null===c.state||"user"in c.state||(c.state.user=a.user),c._onStateChange();var e=c.settings.defaultPostLoginPath;null!==c.priorPath&&(e=c.priorPath),b.path(e).replace()})},cancelLogin:function(){this.auth.cancelLogin()},refreshLogin:function(){if(!this.loggedIn())throw"Cannot refresh, not logged in.";var a=this;return this.auth.refreshLogin(this.state).then(function(b){var c=a.state.user;a.state=b.newState,null===a.state||"user"in a.state||(a.state.user=c),a._onStateChange()})},logout:function(){if(this.loggedIn()){if(null!==this.settings.logoutUrl){var a=d.get("$http"),c={method:"POST",data:"",url:this.settings.logoutUrl};this.updateRequestConf(c),a(c)}this.reset(),b.path(this.settings.loginPath)}},reset:function(){this.state=null,this._onStateChange()},cookieKey:function(){return this.settings.sessionName+"-"+this.auth.getAuthType()},updateRequestConf:function(a){a.sessionDictKey=this.cookieKey(),this.loggedIn()&&(a.headers||(a.headers={}),this.auth.addAuthToRequestConf(a,this.state))},manageRequestConf:function(a){this.managedHttpConfs.push({conf:a,original:angular.copy(a)}),this.updateRequestConf(a)},reupdateManagedRequestConfs:function(){var a=this;angular.forEach(this.managedHttpConfs,function(b){for(var c in b.conf)delete b.conf[c];var d=angular.copy(b.original);angular.extend(b.conf,d),a.updateRequestConf(b.conf)})},handleHttpResponse:function(c){var d=this.auth.checkResponse(c);return d.authFailure?(this.reset(),this.priorPath=b.path(),b.path(this.settings.loginPath).replace(),a.reject(c)):c},_onStateChange:function(){if(this.reupdateManagedRequestConfs(),null!==this.state){if(this.settings.useCookies&&c.put(this.cookieKey(),this.state),null!==this.refreshPromise&&f.cancel(this.refreshPromise),"millisecondsToRefresh"in this.state){var a=this;this.refreshPromise=f(function(){a.refreshLogin()},this.state.millisecondsToRefresh)}}else null!==this.refreshPromise&&(f.cancel(this.refreshPromise),this.refreshPromise=null),this.settings.useCookies&&c.remove(this.cookieKey())}};var j=function(a,b){return new i(a,b)};return j.dictionary=h,j}]),angular.module("secureNgResource").factory("mockAuth",["$q",function(a){var b=function(){},c=function(a){if(a.user)return a.user;if(a.openid_identifier){var b=a.openid_identifier,c=/^(?:[a-z]+:\/\/)?([^\/]+).*?([^\/]*)$/,d=c.exec(b);if(d){var e=d[2]||"john.doe",f=d[1];return e+"@"+f}}return"john.doe@example.com"};b.prototype={getAuthType:function(){return"MockAuth"},checkLogin:function(b){var d=a.defer();return String(b.pass).indexOf("fail")>-1||String(b.openid_identifier).indexOf("fail")>-1?d.reject({status:"denied"}):d.resolve({status:"accepted",newState:{user:c(b)}}),d.promise},cancelLogin:function(){},refreshLogin:function(b){var c=a.defer();return c.resolve({status:"accepted",newState:b}),c.promise},checkResponse:function(a){var b={};return(401===a.status||403===a.status)&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="Mock "+b.user}};var d=function(){return new b};return d}]),angular.module("secureNgResource").factory("openIDAuth",["$q","$rootScope",function(b,c){var d={popup:{begin:function(b,d,e){var f=function(){delete a.handleAuthResponse,delete a.openIdPopup};if(a.handleAuthResponse=function(a){c.$apply(function(){f(),a.approved?e.resolve({status:"accepted",newState:{sessionId:a.sessionId,user:a.user||void 0}}):e.reject({status:"denied",msg:a.message||"Access denied"})})},a.hasOwnProperty("openIdPopup")&&!a.openIdPopup.closed&&(a.openIdPopup.close(),f()),"object"==typeof b.query){d+="?";var g=!0;angular.forEach(b.query,function(a,b){g?g=!1:d+="&",d+=encodeURIComponent(b),d+="=",d+=encodeURIComponent(a)})}var h="width=450,height=500,location=1,status=1,resizable=yes",i=a.open("","openid_popup",h);i.onclose=function(){f()},i.document.write('<form id="shimform" method="post" action="'+d+'"><input type="hidden" name="openid_identifier" id="oid" /></form>'),i.document.getElementById("oid").value=b.openid_identifier,i.document.getElementById("shimform").submit(),a.openIdPopup=i},cancel:function(){a.hasOwnProperty("openIdPopup")&&(a.openIdPopup.close(),delete a.openIdPopup,delete a.handleAuthResponse)}}},e=function(a,b){if(this.authUrl=a,this.login=d[b],!this.login)throw"Invalid login mode"};e.prototype={getAuthType:function(){return"OpenIDAuth"},checkLogin:function(a){var c=b.defer();return this.login.begin(a,this.authUrl,c),c.promise},cancelLogin:function(){d.popup.cancel()},refreshLogin:function(){var a=b.defer();return a.reject(),a.promise},checkResponse:function(a){var b={};return(401===a.status||403===a.status)&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="SesID "+b.sessionId}};var f=function(a,b){return new e(a,b)};return f}]),angular.module("secureNgResource").factory("passwordOAuth",["$http","$q",function(a,b){var c=function(a,b,c){this.host=a,this.clientId=b,this.clientSecret=c},d=function(a){var b="";return angular.forEach(a,function(a,c){b.length>0&&(b+="&"),b+=c+"="+encodeURIComponent(a)}),b},e=function(a){if(200===a.status&&angular.isString(a.data.access_token)){var b=a.data;return{status:"accepted",newState:{accessToken:b.access_token,accessTokenExpires:(new Date).getTime()+b.expires_in,millisecondsToRefresh:1e3*b.expires_in/2,refreshToken:b.refresh_token}}}if(400===a.status&&"invalid_grant"===a.data.error)return{status:"denied",msg:"Invalid username or password"};var c="HTTP Status "+a.status;return 0===a.status?c="Unable to connect to authentication server":a.data.error_description&&(c="OAuth:"+a.data.error_description),{status:"error",msg:c}};c.prototype={getAuthType:function(){return"PasswordOAuth"},checkLogin:function(c){var f=b.defer();return a({method:"POST",url:this.host+"/oauth/v2/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d({client_id:this.clientId,client_secret:this.clientSecret,grant_type:"password",username:c.user,password:c.pass})}).then(function(a){var b=e(a);"accepted"===b.status?f.resolve(b):f.reject(b)}),f.promise},cancelLogin:function(){},refreshLogin:function(c){var f=b.defer();return a({method:"POST",url:this.host+"/oauth/v2/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d({client_id:this.clientId,client_secret:this.clientSecret,grant_type:"refresh_token",refresh_token:c.refreshToken})}).then(function(a){var b=e(a);"accepted"===b.status?(b.newState.refreshToken||(b.newState.refreshToken=c.refreshToken),f.resolve(b)):f.reject(b)}),f.promise},checkResponse:function(a){var b={};return 401===a.status&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="Bearer "+b.accessToken}};var f=function(a,b,d){return new c(a,b,d)};return f}]),angular.module("secureNgResource").factory("secureResource",["$resource",function(a){var b={get:{method:"GET"},save:{method:"POST"},query:{method:"GET",isArray:!0},remove:{method:"DELETE"},"delete":{method:"DELETE"}};return function(c,d,e,f){var g=angular.extend({},b,f);angular.forEach(g,function(a){c.manageRequestConf(a)}),d=d.replace(/^([^\/].+?)(:\d+\/)/g,"$1\\$2");var h=a(d,e,g);return h}}]),angular.module("secureNgResource").config(["$httpProvider",function(a){a.responseInterceptors.push(["authSession",function(a){var b=function(b){var c=a.dictionary[b.config.sessionDictKey];return c?c.handleHttpResponse(b):b};return function(a){return a.then(b,b)}}])}])}(window);
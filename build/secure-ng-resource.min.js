!function(a){"use strict";angular.module("secureNgResource",["ngResource","ngCookies"]),angular.module("secureNgResource").factory("authSession",["$q","$location","$cookieStore","$injector","$rootScope","$timeout",function(a,b,c,d,e,f){function g(a,b){if(this.auth=a,this.settings=angular.extend({},h,b),this.state={},this.managedHttpConfs=[],this.refreshPromise=null,i[this.cookieKey()]=this,this.settings.useCookies){var d=c.get(this.cookieKey());d?(this.state=d,this._onStateChange()):this.reset()}else this.reset()}var h={sessionName:"angular",loginPath:"/login",logoutUrl:null,defaultPostLoginPath:"/",useCookies:!0},i={};g.prototype={getUserName:function(){if(this.loggedIn())return this.state.user},getUserId:function(){if(this.loggedIn())return this.state.userId},loggedIn:function(){return!(!this.state||!this.state.user)},login:function(a){var c=this;return this.auth.checkLogin(a).then(function(d){var e=c.settings.defaultPostLoginPath,f=c.state.priorIdleUser;c.state.priorUrl&&(e=c.state.priorUrl),c.state=d.newState,"user"in c.state||(c.state.user=a.user),f&&c.state.user!==f&&(e=c.settings.defaultPostLoginPath),c._onStateChange(),b.url(e).replace()})},cancelLogin:function(){this.auth.cancelLogin()},refreshLogin:function(){if(!this.loggedIn())throw"Cannot refresh, not logged in.";var a=this;return this.auth.refreshLogin(this.state).then(function(b){var c=a.state.user;a.state=b.newState,"user"in a.state||(a.state.user=c),a._onStateChange()})},logout:function(){if(this.loggedIn()){if(null!==this.settings.logoutUrl){var a=d.get("$http"),b={method:"POST",data:"",url:this.settings.logoutUrl};this.updateRequestConf(b),a(b)}this.reset(),this.goToLoginPage()}},idleLogout:function(){if(this.loggedIn()){var a=b.url(),c=this.getUserName();this.logout(),c&&(this.state.priorUrl=a,this.state.priorIdleUser=c,this._onStateChange())}},reset:function(){this.state={},this._onStateChange()},cookieKey:function(){return this.settings.sessionName+"-"+this.auth.getAuthType()},updateRequestConf:function(a){a.sessionDictKey=this.cookieKey(),this.loggedIn()&&(a.headers||(a.headers={}),this.auth.addAuthToRequestConf(a,this.state))},manageRequestConf:function(a){this.managedHttpConfs.push({conf:a,original:angular.copy(a)}),this.updateRequestConf(a)},reupdateManagedRequestConfs:function(){var a=this;angular.forEach(this.managedHttpConfs,function(b){for(var c in b.conf)delete b.conf[c];var d=angular.copy(b.original);angular.extend(b.conf,d),a.updateRequestConf(b.conf)})},handleHttpResponse:function(c){var d=this.auth.checkResponse(c);if(d.authFailure){var e=this.state.priorUrl;return this.reset(),b.url()!==this.settings.loginPath?this.state.priorUrl=b.url():this.state.priorUrl=e,this._onStateChange(),this.goToLoginPage(),a.reject(c)}return c},goToLoginPage:function(){b.url(this.settings.loginPath)},_onStateChange:function(){if(this.reupdateManagedRequestConfs(),this.settings.useCookies&&c.put(this.cookieKey(),this.state),null!==this.refreshPromise&&(f.cancel(this.refreshPromise),this.refreshPromise=null),this.state.millisecondsToRefresh){var a=this;this.refreshPromise=f(function(){a.refreshLogin()},this.state.millisecondsToRefresh)}}};var j=function(a,b){var c=new g(a,b);return c};return j.dictionary=i,j}]),angular.module("secureNgResource").factory("mockAuth",["$q",function(a){var b=function(){},c=function(a){if(a.user)return a.user;if(a.openid_identifier){var b=a.openid_identifier,c=/^(?:[a-z]+:\/\/)?([^\/]+).*?([^\/]*)$/,d=c.exec(b);if(d){var e=d[2]||"john.doe",f=d[1];return e+"@"+f}}return"john.doe@example.com"};b.prototype={getAuthType:function(){return"MockAuth"},checkLogin:function(b){var d=a.defer();return String(b.pass).indexOf("fail")>-1||String(b.openid_identifier).indexOf("fail")>-1?d.reject({status:"denied"}):d.resolve({status:"accepted",newState:{user:c(b)}}),d.promise},cancelLogin:function(){},refreshLogin:function(b){var c=a.defer();return c.resolve({status:"accepted",newState:b}),c.promise},checkResponse:function(a){var b={};return 401===a.status&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="Mock "+b.user}};var d=function(){return new b};return d}]),angular.module("secureNgResource").factory("openIDAuth",["$q","$rootScope","$cookieStore","$http","shimFormSubmitter","simpleCrypt","$location",function(a,b,c,d,e,f,g){var h=function(a,b){this.authUrl=a,b=b||{},this.refreshUrl=b.refreshUrl,this.refreshTime=b.refreshTime};h.prototype={getAuthType:function(){return"OpenIDAuth"},checkLogin:function(b){var d=a.defer();if(b.openid_identifier){var h=f.generateKey();c.put("login-key",{key:h}),e.submit(this.authUrl,{openid_identifier:b.openid_identifier,key:h,target_url:g.absUrl()})}else{if(!b.auth_resp)throw"Require openid_identifier in credentials";var i=c.get("login-key");if(i){var j=i.key,k=JSON.parse(base64.decode(b.auth_resp));if(c.remove("login-key"),k.approved){var l=base64.decode(k.sessionId),m={sessionId:f.apply(l,j),user:k.user};k.userId&&(m.userId=k.userId),this.refreshTime&&(m.millisecondsToRefresh=this.refreshTime),d.resolve({status:"accepted",newState:m})}else d.reject({status:"denied",msg:k.message||"Access Denied"})}else d.reject({status:"error",msg:"Login failed, decryption key not found"})}return d.promise},cancelLogin:function(){c.remove("login-key")},refreshLogin:function(b){if(this.refreshUrl){var c=angular.copy(b),e={headers:{}};this.addAuthToRequestConf(e,b);var f=d.post(this.refreshUrl,"",e),g=this;return f.then(function(){return g.refreshTime?c.millisecondsToRefresh=g.refreshTime:c.millisecondsToRefresh=null,{newState:c}})}var h=a.defer();return h.reject(),h.promise},checkResponse:function(a){var b={};return 401===a.status&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="SesID "+b.sessionId}};var i=function(a,b){return new h(a,b)};return i}]),angular.module("secureNgResource").factory("passwordJWTAuth",["$http","$q",function(a,b){var c=function(a,b){this.authUrl=a,b=b||{},this.refreshUrl=b.refreshUrl},d=function(a){var b=jwt_decode(a),c=1e3*b.exp-Date.now();return{jwt:a,userId:b.sub,millisecondsToRefresh:c/2}};c.prototype={getAuthType:function(){return"PasswordJWTAuth"},checkLogin:function(c){var e=b.defer();return a({method:"POST",url:this.authUrl,headers:{"Content-Type":"application/json"},data:JSON.stringify({username:c.user,password:c.pass})}).then(function(a){if(200===a.status)e.resolve({status:"accepted",newState:d(a.data.jwt)});else{var b;b=404===a.status?"Invalid user or password":a.data.error||"Server error",e.reject({status:"denied",msg:b})}}),e.promise},cancelLogin:function(){},refreshLogin:function(c){var e=b.defer();return a({method:"POST",url:this.refreshUrl,headers:{"Content-Type":"application/json",Authorization:"Bearer "+c.jwt}}).then(function(a){200===a.status?e.resolve({status:"accepted",newState:d(a.data.jwt)}):e.reject()}),e.promise},checkResponse:function(a){var b={};return 401===a.status&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="Bearer "+b.jwt}};var e=function(a,b){return new c(a,b)};return e}]),angular.module("secureNgResource").factory("passwordOAuth",["$http","$q",function(a,b){var c=function(a,b,c){this.host=a,this.clientId=b,this.clientSecret=c},d=function(a){var b="";return angular.forEach(a,function(a,c){b.length>0&&(b+="&"),b+=c+"="+encodeURIComponent(a)}),b},e=function(a){if(200===a.status&&angular.isString(a.data.access_token)){var b=a.data;return{status:"accepted",newState:{accessToken:b.access_token,accessTokenExpires:(new Date).getTime()+b.expires_in,millisecondsToRefresh:1e3*b.expires_in/2,refreshToken:b.refresh_token}}}if(400===a.status&&"invalid_grant"===a.data.error)return{status:"denied",msg:"Invalid username or password"};var c="HTTP Status "+a.status;return 0===a.status?c="Unable to connect to authentication server":a.data.error_description&&(c="OAuth:"+a.data.error_description),{status:"error",msg:c}};c.prototype={getAuthType:function(){return"PasswordOAuth"},checkLogin:function(c){var f=b.defer();return a({method:"POST",url:this.host+"/oauth/v2/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d({client_id:this.clientId,client_secret:this.clientSecret,grant_type:"password",username:c.user,password:c.pass})}).then(function(a){var b=e(a);"accepted"===b.status?f.resolve(b):f.reject(b)},function(a){f.reject(e(a))}),f.promise},cancelLogin:function(){},refreshLogin:function(c){var f=b.defer();return a({method:"POST",url:this.host+"/oauth/v2/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d({client_id:this.clientId,client_secret:this.clientSecret,grant_type:"refresh_token",refresh_token:c.refreshToken})}).then(function(a){var b=e(a);"accepted"===b.status?(b.newState.refreshToken||(b.newState.refreshToken=c.refreshToken),f.resolve(b)):f.reject(b)},function(a){f.reject(e(a))}),f.promise},checkResponse:function(a){var b={};return 401===a.status&&(b.authFailure=!0),b},addAuthToRequestConf:function(a,b){a.headers.Authorization="Bearer "+b.accessToken}};var f=function(a,b,d){return new c(a,b,d)};return f}]),angular.module("secureNgResource").factory("secureResource",["$resource",function(a){var b={get:{method:"GET"},save:{method:"POST"},query:{method:"GET",isArray:!0},remove:{method:"DELETE"},"delete":{method:"DELETE"}};return function(c,d,e,f){var g=angular.extend({},b,f);angular.forEach(g,function(a){c.manageRequestConf(a)}),d=d.replace(/^([^\/].+?)(:\d+\/)/g,"$1\\$2");var h=a(d,e,g);return h}}]),angular.module("secureNgResource").factory("shimFormSubmitter",["$document",function(a){return{submit:function(b,c){var d=angular.element("<form></form>",{id:"shimform",style:"display: none",method:"post",action:b});angular.forEach(c,function(a,b){d.prepend(angular.element("<input />",{type:"hidden",name:b,value:a}))}),a.find("body").append(d),document.getElementById("shimform").submit()}}}]),angular.module("secureNgResource").value("simpleCrypt",{generateKey:function(){for(var a="";a.length<64;)a+=String.fromCharCode(Math.floor(255*Math.random()));return base64.encode(a)},apply:function(a,b){b=base64.decode(b);for(var c="",d=0;d<a.length;++d)if(d<b.length){var e=a.charCodeAt(d)^b.charCodeAt(d);c+=String.fromCharCode(e)}else c+=a.charAt(d);return c}}),angular.module("secureNgResource").factory("secureResourceHttpInterceptor",["authSession","$q",function(a,b){var c=function(b){var c=a.dictionary[b.config.sessionDictKey];return c?c.handleHttpResponse(b):b};return{response:function(a){return c(a)},responseError:function(a){return a=c(a),b.reject(a)}}}]),angular.module("secureNgResource").config(["$httpProvider",function(a){a.interceptors.push("secureResourceHttpInterceptor")}])}(window);